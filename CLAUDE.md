# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

A mobile-friendly interactive cooking timer built with Eleventy (11ty) v3 and Nunjucks templates. Displays recipe steps with real-time countdowns and timeline views.

**Tech stack:** Bun (runtime/package manager), 11ty v3, Nunjucks, daisyUI (Tailwind CSS), Zod validation, vanilla JavaScript with localStorage.

## Commands

```bash
bun start                            # Dev server at localhost:8080
bun run build                        # Build to _site/ (runs validation via prebuild)
bun run validate                     # Validate recipes.json and processes.json against Zod schemas
bun run generate <slug>              # Generate process data for a recipe (REQUIRED after editing recipes.json)
bun run image-to-recipe <img> [slug] # Generate recipe from image using GPT-4.1-mini (requires OPENAI_API_KEY)
bunx vitest                          # Run tests
bunx vitest run                      # Run tests once (no watch)
```

## Architecture: Dual Schema System

The app uses two separate JSON data files representing different stages:

### RecipeSchema (`src/_data/recipes.json`)
- Human-authored recipe data with ingredients and sequential steps
- Source of truth for recipe content
- Edit this file when adding/modifying recipes

### CookingProcessSchema (`src/_data/processes.json`)
- **Generated file - NEVER edit manually**
- Timing-optimized data with `startMinute` for each step, `isCriticalPath` flags
- Generated by `scripts/generate-process.js` which transforms RecipeSchema into CookingProcessSchema

### Required Workflow for Recipe Changes
1. Edit `src/_data/recipes.json`
2. Run `bun run validate`
3. Run `bun run generate <recipe-slug>` - **REQUIRED**
4. Commit both files together

## Key Patterns

### Recipe Slugs
- Used as keys in both JSON files
- Kebab-case naming: `pasta-carbonara`
- Used in URLs: `/recipes/pasta-carbonara/`
- Used in localStorage keys for timer state

### Serving Size Scaling
Explicit quantities per serving (no multipliers):
```json
"quantitiesByServings": { "2": 200, "3": 300, "4": 400 }
```

### Parallel Cooking Blocks
Use `type: 'parallel'` in CookingProcessSchema for simultaneous tasks. Use `resource` field ('stovetop', 'pan', 'oven') to prevent conflicts.

### Client-Side State
Timer state stored in localStorage with key `cookingTimer`, indexed by recipe slug. Contains `startTime`, `servingSize`, `currentStepId`. Timeline calculations done client-side using `Date.now()` vs `state.startTime`.

### Dynamic Page Generation
Recipe pages use Eleventy pagination to generate `/recipes/<slug>/` from `recipes.json` keys. Recipe data embedded in HTML at build time, accessed via `window.recipeData`.

## File Organization

- `src/_includes/layouts/base.njk` - Base layout with daisyUI theme switching
- `src/_includes/components/*.njk` - Reusable UI components (step-card, timer-controls, timeline-view)
- `src/_includes/macros/recipe-macros.njk` - Helper macros for ingredient lists, time formatting
- `src/recipes/recipe.njk` - Dynamic recipe page using Eleventy pagination
- `src/js/timer.js` - TimerManager for localStorage state
- `src/js/timeline.js` - TimelineManager calculates upcoming/current steps from elapsed time
- `src/js/recipe-data.js` - Serving size selection and ingredient quantity updates
- `src/schemas/` - Zod validation schemas (recipe-schema.js, cooking-process-schema.js)

## Eleventy Config (`.eleventy.js`)

Custom filters: `formatMinutes` (converts to "2h 30m"), `json` (serializes for HTML data attributes).
Path prefix: `/chickadee/`
No bundling - JS/CSS copied as-is via passthrough.

## Deployment

Pushes to `main` trigger GitHub Pages deployment via `.github/workflows/deploy.yml`. Build fails if validation fails (prebuild runs validate).
