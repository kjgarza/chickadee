# Cooking Timer App - AI Agent Instructions

## Architecture Overview

This is a mobile-friendly interactive cooking timer built with **Eleventy (11ty)** static site generator and **Nunjucks** templates. The app displays recipe steps with real-time countdowns and timeline views.

**Key technology stack:**
- **bun** as the JavaScript runtime and package manager
- 11ty v3 with Nunjucks templating
- daisyUI (Tailwind CSS) for styling  
- Zod for runtime schema validation
- Vanilla JavaScript with localStorage for timer persistence

## Data Architecture & Dual Schema System

The app uses **two separate schemas** representing different stages of recipe data:

### 1. RecipeSchema (`src/schemas/recipe-schema.js`)
- **Source:** `src/_data/recipes.json`
- **Purpose:** Human-authored recipe data with ingredients and sequential steps
- **Key fields:** `ingredients[]`, `steps[]` with `durationMinutes`, `servings` with scaling factors
- **Scaling:** Ingredients use `quantitiesByServings` object mapping serving sizes to quantities

### 2. CookingProcessSchema (`src/schemas/cooking-process-schema.js`)
- **Source:** `src/_data/processes.json` (generated, not hand-written)
- **Purpose:** Timing-optimized cooking instructions for real-time execution
- **Key fields:** `timeline[]` with `startMinute`, `type` ('action' or 'parallel'), `isCriticalPath`
- **Generated by:** `scripts/generate-process.js` which transforms RecipeSchema ‚Üí CookingProcessSchema

**Critical distinction:** Never manually edit `processes.json`. Always edit `recipes.json` then regenerate process data.

## Developer Workflows

### Starting development
```bash
bun start           # Runs eleventy --serve on localhost:8080
```

### Adding/editing recipes (REQUIRED workflow)
1. Edit `src/_data/recipes.json` following RecipeSchema
2. Run validation: `bun run validate` (uses Zod schemas)
3. **Generate process data:** `bun run generate <recipe-slug>` - **REQUIRED after editing recipes.json**
4. Commit both `recipes.json` and `processes.json` together

**Critical:** Always regenerate `processes.json` after editing recipes. The build will fail validation if they're out of sync.

### Build pipeline
```bash
bun run validate    # Validates both recipes.json and processes.json against Zod schemas
bun run build       # Runs validation, then builds static site to _site/
```

**Pre-build validation:** The `prebuild` script ensures invalid data never reaches production.

### Deployment
Pushes to `main` branch trigger automatic deployment to GitHub Pages via `.github/workflows/deploy.yml`:
1. Install dependencies with bun
2. Run validation (fails build if invalid)
3. Build static site to `_site/`
4. Deploy to GitHub Pages

## File Organization Patterns

### Nunjucks Templates
- `src/_includes/layouts/base.njk` - Base layout with daisyUI theme switching
- `src/_includes/components/*.njk` - Reusable UI components (step cards, timer controls)
- `src/_includes/macros/recipe-macros.njk` - Helper macros for ingredient lists, time formatting
- `src/recipes/recipe.njk` - Dynamic recipe page template using pagination

### Dynamic Page Generation
The recipe pages use **Eleventy pagination** to generate individual pages:
```njk
---
pagination:
  data: recipes
  size: 1
  alias: slug
permalink: "/recipes/{{ slug }}/"
---
```
This creates `/recipes/pasta-carbonara/`, `/recipes/[recipe-slug]/` etc. from `recipes.json` keys.

### Client-Side JavaScript Modules
- `src/js/timer.js` - **TimerManager** object manages localStorage state per recipe
- `src/js/timeline.js` - **TimelineManager** calculates upcoming/current steps from elapsed time
- `src/js/recipe-data.js` - Handles serving size selection and ingredient quantity updates

**State persistence:** Timer state stored in localStorage with key `cookingTimer`, indexed by recipe slug.

## Eleventy Configuration (`.eleventy.js`)

Custom filters defined:
- `formatMinutes` - Converts minutes to "2h 30m" or "45m" format
- `json` - Serializes objects for embedding in HTML data attributes

Passthrough copies: `src/js/` and `src/css/` copied directly to `_site/` (no bundling).

## Conventions & Patterns

### Recipe Slugs
- Used as keys in `recipes.json` and `processes.json`
- Must match: kebab-case naming (e.g., `pasta-carbonara`)
- Used in URLs: `/recipes/pasta-carbonara/`
- Used in localStorage keys for timer state

### Serving Size Scaling
Ingredients don't use multipliers. Instead:
```json
"quantitiesByServings": { "2": 200, "3": 300, "4": 400 }
```
Explicitly define quantities for each serving count (min to max).

### Step Timing
- `steps[].durationMinutes` in RecipeSchema is **optional** (prep steps may have no duration)
- In CookingProcessSchema, `timeline[].startMinute` is cumulative from recipe start
- Timer calculates countdowns: `(step.startMinute * 60000 + step.durationMinutes * 60000) - elapsedMs`

### Critical Path Marking
Use `isCriticalPath: true` in process timeline to highlight time-sensitive steps (boiling pasta, timed cooking).

### Parallel Cooking Blocks
Use `type: 'parallel'` in CookingProcessSchema for tasks that can be done simultaneously:
```json
{
  "id": "prep-parallel",
  "type": "parallel",
  "startMinute": 0,
  "actions": [
    {
      "id": "prep-pancetta",
      "type": "action",
      "instruction": "Cut pancetta into small cubes",
      "startMinute": 0,
      "durationMinutes": 3,
      "isCriticalPath": false
    },
    {
      "id": "mix-eggs",
      "type": "action",
      "instruction": "Whisk eggs...",
      "startMinute": 0,
      "durationMinutes": 2,
      "isCriticalPath": false
    }
  ]
}
```
**Use case:** Prep tasks that can happen while waiting for water to boil, or simultaneous cooking on multiple burners.
**Resource tracking:** Use `resource` field ('stovetop', 'pan', 'oven') to prevent conflicts in parallel blocks.

## Current Development Tasks

Reference [TASKS.md](../TASKS.md) for active work items. Key patterns:
- Timer should collapse ingredients/servings when started
- Past steps should be hidden automatically  
- Pause functionality needed (not yet implemented)

## Styling & Theming

- **daisyUI themes:** Loaded via CDN, theme switching in base layout
- **Responsive:** max-w-2xl container, Tailwind utility classes
- **Icons:** Emoji used throughout UI (üç≥, ü•ò, ‚è±Ô∏è)
- **Cards:** daisyUI `.card` class for ingredient/step sections

## OpenGraph Metadata

Recipe pages should include OpenGraph metadata for social sharing:
- `og:title` - Recipe name
- `og:description` - Recipe description or first step summary
- `og:image` - Recipe image (placeholder: `/assets/images/og/recipe-placeholder.png`)
- `og:type` - "article" for recipe pages
- `og:url` - Canonical URL of the recipe page

**Image requirements:**
- Place OpenGraph images in `src/assets/images/og/`
- Recommended size: 1200x630px
- Use recipe slug as filename: `pasta-carbonara.png`
- Fallback to `recipe-placeholder.png` if no specific image exists

## Important Notes

- **No build tools/bundlers:** JavaScript/CSS copied as-is (intentionally simple)
- **Server-side rendering:** Recipe data embedded in HTML at build time, accessed via `window.recipeData`
- **Validation is mandatory:** Scripts will exit(1) on validation failure to prevent bad data
- **Timeline calculations:** All done client-side based on `Date.now()` vs `state.startTime` from localStorage
